---
import { getPosts, getPostBySlug } from '../../lib/queries';
import { urlFor } from '../../lib/sanity';
import BlogPost from '../../layouts/BlogPost.astro';
import { toHTML } from '@portabletext/to-html';

interface Author {
  name: string;
  image?: {
    asset: {
      _ref: string;
    };
  };
  bio?: string;
}

interface Category {
  title: string;
}

interface SanityPost {
  title: string;
  slug: { current: string };
  excerpt?: string;
  publishedAt: string;
  mainImage?: {
    asset: {
      _ref: string;
    };
  };
  // legacy fallbacks
  image?: {
    asset: {
      _ref: string;
    };
  };
  content?: any[];
  author?: Author;
  categories?: Category[];
  body?: any[];
}

export async function getStaticPaths() {
  const posts = await getPosts() as SanityPost[];
  return posts.map(post => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;
const post = await getPostBySlug(slug as string);

if (!post) {
  return Astro.redirect('/404');
}

// Use legacy fallbacks when necessary
const postImage = post.mainImage ?? post.image;
const rawContent = post.body ?? post.content;

const frontmatter = {
  title: post.title,
  description: post.excerpt || post.title,
  pubDate: new Date(post.publishedAt),
  image: postImage ? urlFor(postImage).width(1200).url() : null,
  author: post.author?.name || 'Healthcare Team',
  category: post.categories?.[0]?.title || 'General',
  tags: post.categories?.map(cat => cat.title) || []
};

// Use @portabletext/to-html to render portable text to HTML on the server
let contentHtml: string | null = null;
if (rawContent && Array.isArray(rawContent) && rawContent.length > 0) {
  contentHtml = toHTML(rawContent, {
    // Provide custom serializers for types/marks that need special handling
    components: {
      types: {
        image: ({ value }) => {
          // value is the image block from Sanity
          try {
            const src = urlFor(value).width(1200).url();
            const alt = value.alt || '';
            return `<img src="${src}" alt="${alt}" class="content-image" />`;
          } catch (e) {
            return '';
          }
        }
      },
      marks: {
        link: ({ children, value }) => {
          const href = value?.href || '#';
          const target = value?.blank ? ' target="_blank" rel="noopener noreferrer"' : '';
          return `<a href="${href}"${target}>${children}</a>`;
        }
      }
    }
  });
}
---

<BlogPost frontmatter={frontmatter}>
  <div class="post-content">
    {contentHtml ? (
      <div set:html={contentHtml} />
    ) : (
      <div class="no-content">
        <p>{post.excerpt || 'This article has no body content yet.'}</p>
      </div>
    )}
  </div>

  {post.author && (
    <div class="author-bio">
      {post.author.image && (
        <img 
          src={urlFor(post.author.image).width(100).url()} 
          alt={post.author.name}
          class="author-image"
        />
      )}
      <div>
        <h3>{post.author.name}</h3>
        {post.author.bio && <p>{post.author.bio}</p>}
      </div>
    </div>
  )}
</BlogPost>

<style>
  .post-content {
    margin: 2rem 0;
    line-height: 1.8;
  }

  .content-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 2rem 0;
  }

  .author-bio {
    display: flex;
    gap: 1.5rem;
    padding: 2rem;
    background: #f5f5f5;
    border-radius: 8px;
    margin-top: 3rem;
    align-items: flex-start;
  }

  .author-image {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }

  .author-bio h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.125rem;
  }

  .author-bio p {
    margin: 0;
    color: #666;
    font-size: 0.95rem;
  }

  @media (max-width: 768px) {
    .author-bio {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .author-image {
      width: 80px;
      height: 80px;
    }
  }
</style>