---
import { getPosts, getPostBySlug } from '../../lib/queries';
import { urlFor } from '../../lib/sanity';
import BlogPost from '../../layouts/BlogPost.astro';
import { sanityPortableText } from '../../lib/portableText';
import type { SanityPost } from '../../lib/types';

export async function getStaticPaths() {
  const posts = await getPosts() as SanityPost[];
  return posts.map(post => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;
const post = await getPostBySlug(slug as string);

if (!post) {
  return Astro.redirect('/404');
}

// Use legacy fallbacks when necessary
const postImage = post.mainImage ?? post.image;
const rawContent = post.body ?? post.content;

const frontmatter = {
  title: post.title,
  description: post.excerpt || post.title,
  pubDate: new Date(post.publishedAt),
  image: postImage ? urlFor(postImage).width(1200).format('webp').quality(80).url() : null,
  author: post.author?.name || 'Healthcare Team',
  category: post.categories?.[0]?.title || 'General',
  tags: post.categories?.map(cat => cat.title) || []
};

let contentHtml: string | null = null;
if (rawContent && Array.isArray(rawContent) && rawContent.length > 0) {
  contentHtml = sanityPortableText(rawContent);
}
---

<BlogPost frontmatter={frontmatter}>
  <div class="post-content">
    {contentHtml ? (
      <div set:html={contentHtml} />
    ) : (
      <div class="no-content">
        <p>{post.excerpt || 'This article has no body content yet.'}</p>
      </div>
    )}
  </div>

  {post.author && (
    <div class="author-bio">
      {post.author.image && (
        <img 
          src={urlFor(post.author.image).width(100).url()} 
          alt={post.author.name}
          class="author-image"
        />
      )}
      <div>
        <h3>{post.author.name}</h3>
        {post.author.bio && <p>{post.author.bio}</p>}
      </div>
    </div>
  )}
</BlogPost>

<style>
  .post-content {
    margin: 2rem 0;
    line-height: 1.8;
  }

  .content-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 2rem 0;
  }

  .author-bio {
    display: flex;
    gap: 1.5rem;
    padding: 2rem;
    background: #f5f5f5;
    border-radius: 8px;
    margin-top: 3rem;
    align-items: flex-start;
  }

  .author-image {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }

  .author-bio h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.125rem;
  }

  .author-bio p {
    margin: 0;
    color: #666;
    font-size: 0.95rem;
  }

  @media (max-width: 768px) {
    .author-bio {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .author-image {
      width: 80px;
      height: 80px;
    }
  }
</style>